<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN"
 "http://mybatis.org/dtd/mybatis-3-mapper.dtd">

<mapper namespace="com.bitc.wub.mapper.ArticleMapper">

	<!-- 도서 대분류 -->
	<select id="tagMainCategori" resultType="com.bitc.wub.dto.TagDto">
		<![CDATA[ 
			SELECT 
				tag_idx, tag_content 
			FROM 
				tag 
			WHERE 
				tag_idx LIKE '%00' 
			OR 
				tag_idx = 0 
			ORDER BY 
				tag_idx ASC
		]]>
	</select>
	
	<!-- 도서 세부분류 -->
	<select id="tagDetailCategori" resultType="com.bitc.wub.dto.TagDto">
		<![CDATA[ 
			SELECT
				tag_idx, tag_content
			FROM
				tag
			WHERE
				tag_idx > #{tagIdx} AND tag_idx < #{tagIdx2}
			ORDER BY 
				tag_idx ASC
		]]>
	</select>
	
	<!-- 글쓰기 -->
	<insert id="insertArticle" parameterType="com.bitc.wub.dto.ArticleDto" useGeneratedKeys="true" keyProperty="bookIdx">
		<![CDATA[ 
			INSERT INTO book
				(book_title, book_contents, user_idx, book_price, create_date, book_tab, book_negotiation, main_categori, detail_categori)
			VALUES
				(#{bookTitle}, #{bookContents}, #{userIdx}, #{bookPrice}, NOW(), #{bookTab}, #{bookNegotiation}, #{mainCategori}, #{detailCategori})
		]]>
	</insert>
	
	<!-- 글쓰기(이미지) -->
	<insert id="insertArticleFileList" parameterType="com.bitc.wub.dto.ImgDto">
		<![CDATA[ 
			INSERT INTO book_file 
				(book_idx, original_file_name, stored_file_path, file_size) 
			VALUES 
		]]>
		<foreach collection="list" item="item" separator=",">
			(
			#{item.bookIdx},
			#{item.originalFileName},
			#{item.storedFilePath},
			#{item.fileSize}
			)
		</foreach>
	</insert>
	
	<!-- 글 상세보기 -->
	<select id="selectArticleDetail" resultType="com.bitc.wub.dto.ArticleDto">
		<![CDATA[ 
			SELECT
				book_idx, book_title, book_contents, user_idx, 
				create_date, book_price, hit_cnt, book_tab, sold_yn, 
				book_negotiation, main_categori, detail_categori 
			FROM 
				book 
			WHERE 
				book_idx= #{bookIdx} AND deleted_yn = 'N' 
		]]>
	</select>
	
	<!-- 도서 메인분류 String -->
	<select id="selectMainCategori" resultType="String">
		<![CDATA[ 
			SELECT 
				tag_content 
			FROM 
				tag 
			WHERE 
				tag_idx = #{mainCategori}
		]]>
	</select>
	
	<!-- 도서 세부분류 String -->
	<select id="selectDetailCategori" resultType="String">
		<![CDATA[ 
			SELECT 
				tag_content 
			FROM 
				tag 
			WHERE 
				tag_idx = #{detailCategori}
		]]>
	</select>
	
	<!-- 댓글 쓰기 -->
	<insert id="insertComment" parameterType="com.bitc.wub.dto.CommentDto">
		<![CDATA[ 
			INSERT INTO comment 
				(book_idx, user_idx, comment_content, create_date) 
			VALUES 
				(#{bookIdx}, #{userIdx}, #{commentContent}, NOW()) 
				
		]]>
	</insert>
	
	<!-- 댓글 읽기 -->
	<select id="selectCommentList" resultType="com.bitc.wub.dto.CommentDto">
		<![CDATA[ 
			SELECT 
				comment_idx, book_idx ,user_idx, comment_content, create_date
			FROM
				comment
			WHERE
				book_idx = #{bookIdx} and deleted_yn = 'N'
			
		]]>
	</select>
	
	<!-- 조회수 상승 -->
	<update id="countHitCnt" parameterType="int">
		<![CDATA[ 
			UPDATE
				book 
			SET 
				hit_cnt = hit_cnt + 1 
			WHERE 
				book_idx = #{book_idx} 
			AND 
				deleted_yn = 'N' 
		]]>
	</update>

</mapper>